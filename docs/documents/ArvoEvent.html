<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>ArvoEvent | arvo-core</title><meta name="description" content="Documentation for arvo-core"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><link rel="stylesheet" href="../assets/typedoc-github-style.css"/></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base=".."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">arvo-core</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../index.html">arvo-core</a></li><li><a href="ArvoEvent.html">ArvoEvent</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="md:arvoevent---a-event-design-for-evolutionary-and-reliable-event-driven-architecture" class="tsd-anchor"></a><h1 class="tsd-anchor-link">ArvoEvent - A Event Design for Evolutionary and Reliable Event-Driven Architecture<a href="#md:arvoevent---a-event-design-for-evolutionary-and-reliable-event-driven-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>In the world of event-driven architecture (EDA), managing communication between services presents a unique set of challenges. As systems grow and evolve, the complexity of maintaining reliable service communication often becomes a significant hurdle. Arvo addresses these challenges by providing a standardised event structure, called <code>ArvoEvent</code> that promotes reliability, scalability, and system evolution while remaining flexible enough to adapt to diverse business needs.</p>
<a id="md:the-challenge-of-event-standardisation" class="tsd-anchor"></a><h2 class="tsd-anchor-link">The Challenge of Event Standardisation<a href="#md:the-challenge-of-event-standardisation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Event-driven architectures excel at scalability but face challenges in evolution and reliability due to inconsistent event semantics and formats across teams. While practices like Event Storming help identify event flows and data requirements, the actual implementation often becomes fragmented as teams create incompatible event structures optimised for their specific domains, leading to complex integration challenges and reduced system maintainability as the architecture grows.</p>
<p>To address these challenges, Arvo builds upon the standardised CNCF <code>CloudEvent</code> specification rather than creating a new standard. This approach leverages existing industry knowledge and tooling while adding targeted extensions that support enterprise requirements, enabling teams to maintain consistent event semantics and structure across their distributed systems without sacrificing the flexibility needed for diverse business needs.</p>
<a id="md:core-architecture-the-event-broker-pattern" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Core Architecture: The Event Broker Pattern<a href="#md:core-architecture-the-event-broker-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Arvo uses a centralised event broker pattern that promotes clean separation between services while maintaining clear communication pathways. Here's how it works:</p>
<ol>
<li>Services register with a central event broker, declaring which event types they can process</li>
<li>When events arrive, the broker routes them to appropriate handlers based on registration information</li>
<li>Services process events and emit responses back through the broker</li>
<li>The cycle continues, maintaining a continuous flow of event-based communication</li>
</ol>
<p>This broker-centric architecture eliminates direct service-to-service dependencies. Each service can evolve independently within its bounded context, leading to a more maintainable system that can scale effectively.</p>
<blockquote>
<p><strong>Note:</strong> While a centralised event broker might initially raise concerns about creating a system bottleneck, modern event brokers are specifically engineered to handle massive scale. Moreover, Arvo expects a computationally simple routing mechanism that relies on simple string matching between event destinations <code>to</code> and handler registrations <code>handler.source</code>, allowing the broker to quickly route events without complex logic or state management.</p>
</blockquote>
<a id="md:the-arvoevent-structure" class="tsd-anchor"></a><h2 class="tsd-anchor-link">The <code>ArvoEvent</code> structure<a href="#md:the-arvoevent-structure" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ArvoEvent</code> extends the <code>CloudEvents</code> specification with additional fields necessary for enterprise-grade event-driven systems. Every event must include standard <code>CloudEvents</code> fields and incorporates Arvo-specific <code>extensions</code> for enhanced functionality and routing.</p>
<p>The following table provides a comprehensive overview of <code>ArvoEvent</code> fields, their classification, and the rationale behind their inclusion in the event structure.</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Classification</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>CloudEvent Core</td>
<td>Provides a unique identifier for each event in the system. Generated as a UUID by default to ensure global uniqueness across distributed systems. Essential for event tracking, deduplication, and correlation.</td>
</tr>
<tr>
<td><code>source</code></td>
<td>CloudEvent Core</td>
<td>Identifies the origin of the event (e.g., &quot;order-service&quot;, &quot;payment-processor&quot;). Critical for debugging, auditing, and maintaining system transparency. Helps in understanding event flow and troubleshooting issues.</td>
</tr>
<tr>
<td><code>type</code></td>
<td>CloudEvent Core</td>
<td>Describes the nature of the event using reverse-DNS format (e.g., &quot;com.company.order.created&quot;). This structured format ensures global uniqueness of event types and enables clear categorisation of events. Essential for event routing and processing decisions.</td>
</tr>
<tr>
<td><code>subject</code></td>
<td>CloudEvent Core</td>
<td>Acts as a process identifier, linking related events together. Crucial for tracking business processes that span multiple events and services. Enables correlation of events within a single business transaction or workflow. In Arvo, the <code>ArvoOrchestrator</code> uses this field to keep track of the state across the entire workflow execution</td>
</tr>
<tr>
<td><code>data</code></td>
<td>CloudEvent Core</td>
<td>Contains the actual payload of the event. This is where the business-specific information resides. The structure is defined by the event type and validated against the dataschema.</td>
</tr>
<tr>
<td><code>time</code></td>
<td>CloudEvent Core</td>
<td>Records when the event occurred in ISO 8601 format. Auto-generated if not specified. Essential for event ordering, debugging, and audit trails. Helps maintain temporal relationships between events.</td>
</tr>
<tr>
<td><code>datacontenttype</code></td>
<td>CloudEvent Core</td>
<td>Specifies the format of the data field (e.g., application/json). Ensures correct parsing and processing of event payload. Supports content negotiation between services.</td>
</tr>
<tr>
<td><code>dataschema</code></td>
<td>CloudEvent Core</td>
<td>References the schema that validates the data payload. Ensures data integrity and compatibility across services. Supports contract-based development and system evolution. For event generated in adherence with a <code>ArvoContract</code> this contains the contract URI and version.</td>
</tr>
<tr>
<td><code>to</code></td>
<td>ArvoEvent Extension</td>
<td>Specifies the intended event consumer. Essential for direct routing in a mesh-like architecture. Enables targeted event delivery without creating tight coupling between services.</td>
</tr>
<tr>
<td><code>redirectto</code></td>
<td>ArvoEvent Extension</td>
<td>Enables dynamic routing for complex workflows. Allows events to be redirected based on runtime conditions or business rules. Supports sophisticated orchestration patterns while maintaining service independence.</td>
</tr>
<tr>
<td><code>accesscontrol</code></td>
<td>ArvoEvent Extension</td>
<td>Supports various access control mechanisms from simple user IDs to role-based access. Enables fine-grained security controls at the event level. Critical for maintaining security in distributed systems where events may contain sensitive information or where event originator user need to have specific permission to use an event handler.</td>
</tr>
<tr>
<td><code>executionunits</code></td>
<td>ArvoEvent Extension</td>
<td>Tracks computational cost of event processing. Valuable for system optimisation, capacity planning, and resource utilisation analysis.</td>
</tr>
<tr>
<td><code>traceparent</code></td>
<td>ArvoEvent Extension</td>
<td>Part of OpenTelemetry integration. Carries distributed tracing context across service boundaries. Essential for understanding event flow and diagnosing issues in complex distributed systems.</td>
</tr>
<tr>
<td><code>tracestate</code></td>
<td>ArvoEvent Extension</td>
<td>Supports vendor-specific tracing information as part of OpenTelemetry integration. Enables detailed tracing and monitoring capabilities while maintaining compatibility with various monitoring tools.</td>
</tr>
</tbody>
</table>
<p>The combination of CloudEvent core fields and Arvo extensions creates a robust event structure. The core fields provide essential event identification and payload management, while the extensions enable sophisticated routing, security, monitoring, and cost tracking capabilities.</p>
<p>Here's the updated version of the &quot;Event Creation&quot; section with the provided examples:</p>
<a id="md:creating-arvoevents" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Creating ArvoEvents<a href="#md:creating-arvoevents" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>arvo-core</code> package provides two primary methods for creating an <code>ArvoEvent</code>. The first method is the <code>createArvoEvent</code> function, which constructs the event from the provided parameters. This function ensures that the data supplied to it adheres to the requirements of the event structure. However, it does not validate the contents of the <code>data</code> field.</p>
<pre><code class="typescript"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">event</span><span class="hl-1"> = </span><span class="hl-6">createArvoEvent</span><span class="hl-1">&lt;</span><span class="hl-8">OrderData</span><span class="hl-1">, {}, </span><span class="hl-3">&quot;order.created&quot;</span><span class="hl-1">&gt;({</span><br/><span class="hl-1">  </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.test.test&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.order.create&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">subject:</span><span class="hl-1"> </span><span class="hl-3">&quot;order/123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">orderId:</span><span class="hl-1"> </span><span class="hl-3">&quot;ord-123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">amount:</span><span class="hl-1"> </span><span class="hl-9">99.99</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>The second method involves the <code>createArvoEventFactory</code> and <code>createArvoOrchestratorEventFactory</code> functions. These factory functions accept an <code>ArvoContract</code>, which defines the data structure of the <code>data</code> field, as well as the version and event type. The factory functions create the event by performing specific data validations based on the provided contract. Under the hood, the factory functions utilize the <code>createArvoEvent</code> function to construct the event after validating the data.</p>
<pre><code class="typescript"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">createArvoContract</span><span class="hl-1">, </span><span class="hl-0">type</span><span class="hl-1"> </span><span class="hl-2">ArvoEvent</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;arvo-core&#39;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">createArvoEventHandler</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> </span><span class="hl-2">z</span><span class="hl-1"> </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;zod&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">// Our contract defines the service interface</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">userCreateContract</span><span class="hl-1"> = </span><span class="hl-6">createArvoContract</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-2">uri:</span><span class="hl-1"> </span><span class="hl-3">&quot;#/sample/user/create&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.create.user&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">versions:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-3">&quot;1.0.0&quot;</span><span class="hl-2">:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-2">accepts:</span><span class="hl-1"> </span><span class="hl-2">z</span><span class="hl-1">.</span><span class="hl-6">object</span><span class="hl-1">({</span><br/><span class="hl-1">                </span><span class="hl-2">name:</span><span class="hl-1"> </span><span class="hl-2">z</span><span class="hl-1">.</span><span class="hl-6">string</span><span class="hl-1">(),</span><br/><span class="hl-1">                </span><span class="hl-2">age:</span><span class="hl-1"> </span><span class="hl-2">z</span><span class="hl-1">.</span><span class="hl-6">number</span><span class="hl-1">(),</span><br/><span class="hl-1">            }),</span><br/><span class="hl-1">            </span><span class="hl-2">emits:</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-3">&quot;evt.create.user.success&quot;</span><span class="hl-2">:</span><span class="hl-1"> </span><span class="hl-2">z</span><span class="hl-1">.</span><span class="hl-6">object</span><span class="hl-1">({</span><br/><span class="hl-1">                    </span><span class="hl-2">created:</span><span class="hl-1"> </span><span class="hl-2">z</span><span class="hl-1">.</span><span class="hl-6">boolean</span><span class="hl-1">()</span><br/><span class="hl-1">                })</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">inputEvent</span><span class="hl-1">: </span><span class="hl-8">ArvoEvent</span><span class="hl-1"> = </span><span class="hl-6">createArvoEventFactory</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-2">userCreateContract</span><span class="hl-1">.</span><span class="hl-6">version</span><span class="hl-1">(</span><span class="hl-3">&#39;1.0.0&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">).</span><span class="hl-6">accepts</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-2">subject:</span><span class="hl-1"> </span><span class="hl-3">&quot;some-subject&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.test.test&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-2">name:</span><span class="hl-1"> </span><span class="hl-3">&quot;John Doe&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">age:</span><span class="hl-1"> </span><span class="hl-9">65</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<p>In summary, <code>createArvoEvent</code> performs basic event validations, while the factory functions provide a higher level of data validation based on the specified <code>ArvoContract</code>. For more detailed information on <code>ArvoContract</code> and event factories, please refer to their respective documentation.</p>
<a id="md:data-serialisation-and-immutability" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Data Serialisation and Immutability<a href="#md:data-serialisation-and-immutability" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ArvoEvent</code> handles JSON serialisation and ensures event immutability, providing a reliable foundation for event-driven communication.</p>
<p>It requires that all event data must be JSON-serialisable. This requirement ensures that events can be easily stored, transmitted, and consumed by different systems and services. Moreover, it emphasizes event immutability. Once an event is created, it is frozen to prevent accidental modifications during event propagation while it is being handled by the event handler.</p>
<p>Here's an example that demonstrates the serialisation and deserialisation of <code>ArvoEvent</code>:</p>
<pre><code class="typescript"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">event</span><span class="hl-1"> = </span><span class="hl-6">createArvoEvent</span><span class="hl-1">&lt;</span><span class="hl-8">OrderData</span><span class="hl-1">, {}, </span><span class="hl-3">&quot;order.created&quot;</span><span class="hl-1">&gt;({</span><br/><span class="hl-1">  </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.test.test&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.order.create&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">subject:</span><span class="hl-1"> </span><span class="hl-3">&quot;order/123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">orderId:</span><span class="hl-1"> </span><span class="hl-3">&quot;ord-123&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">amount:</span><span class="hl-1"> </span><span class="hl-9">99.99</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">// Serialize the event to a JSON</span><br/><span class="hl-2">string</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">jsonString</span><span class="hl-1"> = </span><span class="hl-5">JSON</span><span class="hl-1">.</span><span class="hl-6">stringify</span><span class="hl-1">(</span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-6">toJSON</span><span class="hl-1">()); </span><br/><span class="hl-7">// Reconstruct the event from the JSON</span><br/><span class="hl-2">string</span><span class="hl-1"> </span><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">reconstructedEvent</span><span class="hl-1"> = </span><span class="hl-6">createArvoEvent</span><span class="hl-1">(</span><span class="hl-5">JSON</span><span class="hl-1">.</span><span class="hl-6">parse</span><span class="hl-1">(</span><span class="hl-2">jsonString</span><span class="hl-1">));</span>
</code><button type="button">Copy</button></pre>

<a id="md:working-with-event-metadata" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Working with Event Metadata<a href="#md:working-with-event-metadata" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p><code>ArvoEvent</code> provides a rich set of methods and properties for accessing and working with event metadata, enabling developers to easily retrieve and manipulate various aspects of an event for flexible event processing and decision-making. Furthermore, OpenTelemetry attributes can be accessed through the <code>otelAttributes</code> property for advanced tracing and monitoring scenarios.</p>
<pre><code class="typescript"><span class="hl-7">// Accessing event metadata</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">eventId</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">id</span><span class="hl-1">;</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">eventTime</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">time</span><span class="hl-1">;</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">eventData</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">;</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">eventTo</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">to</span><span class="hl-1">;</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">eventRedirectTo</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">redirectto</span><span class="hl-1">;</span><br/><br/><span class="hl-7">// Accessing event extensions</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">cloudEvent</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">cloudevent</span><span class="hl-1">;      </span><span class="hl-7">// Complete CloudEvents format</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">customExtensions</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">extensions</span><span class="hl-1">; </span><span class="hl-7">// Custom extensions only</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">attributes</span><span class="hl-1"> = </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">otelAttributes</span><span class="hl-1">;   </span><span class="hl-7">// OpenTelemetry attributes</span>
</code><button type="button">Copy</button></pre>

<a id="md:the-subject-field-in-arvos-event-driven-orchestration-model" class="tsd-anchor"></a><h2 class="tsd-anchor-link">The <code>subject</code> Field in Arvo's Event-Driven Orchestration Model<a href="#md:the-subject-field-in-arvos-event-driven-orchestration-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The <code>subject</code> field in Arvo plays a crucial role by remaining consistent across all events related to a single workflow execution. This unique identifier ties together every event in the workflow, making it essential for the <code>ArvoOrchestrator</code>to manage the state and progression of the workflow.</p>
<p>At its core, the <code>ArvoOrchestrator</code> is a specialized event handler designed to coordinate complex workflows that span multiple services. It achieves this by maintaining a state machine (typically using a variant of <code>xstate</code>) that defines the steps and transitions within the workflow.</p>
<p>When an event related to a workflow arrives, the <code>ArvoOrchestrator</code> uses the <code>subject</code> field to fetch the current state of that specific workflow instance from a key-value store. It then processes the event according to the state machine's logic, determines the next state and any events that need to be emitted, and stores the updated state back in the key-value store, using the <code>subject</code> as the key. This cycle repeats for each incoming event, with the orchestrator consistently using the <code>subject</code> to retrieve and update the correct workflow state.</p>
<p>In this way, the <code>ArvoOrchestrator</code> can reliably manage multiple concurrent instances of the same workflow. Even if different instances are at different stages the orchestrator can accurately retrieve and update each instance's state independently.</p>
<p>Moreover, having a consistent <code>subject</code> across all events enables powerful auditing and event sourcing capabilities. By storing events with the same <code>subject</code> together, ordered by their <code>time</code> field, it becomes possible to replay the entire history of a workflow to the <code>ArvoOrchestrator</code>. This allows for detailed auditing, as the orchestrator can reconstruct the state at any point in the workflow's lifecycle. Event sourcing also provides a robust foundation for debugging, as issues can be reproduced by replaying the relevant events.</p>
<a id="md:creating-a-subject-in-arvo" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Creating a <code>subject</code> in Arvo<a href="#md:creating-a-subject-in-arvo" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The <code>subject</code> field in an <code>ArvoEvent</code> might appear to be a simple string, but it represents a valuable piece of data real-estate that can carry rich information shared across handlers and services during a single execution. Recognising this potential, the <code>arvo-core</code> package introduces the <code>ArvoOrchestrationSubject</code> utility, which enables the creation of information-rich and unique subject strings. For creation of subject strings in Arvo it is recommended to use only this utility.</p>
<p>Despite its name suggesting an orchestrator-specific purpose, the <code>ArvoOrchestrationSubject</code> can be employed for various event types, including simple events that invoke a single service. This utility becomes particularly crucial for events destined for <code>ArvoOrchestrator</code> event handlers. While high-level utilities like <code>createArvoOrchestratorEventFactory</code> abstract away the complexities of subject creation, understanding the underlying mechanics empowers developers to craft more nuanced and information-rich event subjects.</p>
<blockquote>
<p><strong>Good to know:</strong> The easiest way to figure out which event is going to <code>ArvoOrchestrator</code> event handler is by look at the event type and seeing if the event type is prefixed with <code>arvo.orc.</code></p>
</blockquote>
<p>The utility provides two primary methods for creating subjects:</p>
<ol>
<li>Developers can construct a new subject with comprehensive details using the <code>ArvoOrchestrationSubject.new()</code>method. This approach allows for creating a subject with essential information such as the orchestrator name, version, initiator address, and optional metadata. The method supports adding contextual information like environment details or unique stream topics, providing flexibility in subject creation.</li>
</ol>
<pre><code class="typescript"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">ArvoOrchestrationSubject</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;arvo-core&#39;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">v4</span><span class="hl-1"> </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-2">uuid4</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;uuid&#39;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">subject</span><span class="hl-1"> = </span><span class="hl-2">ArvoOrchestrationSubject</span><span class="hl-1">.</span><span class="hl-6">new</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">orchestator:</span><span class="hl-1"> </span><span class="hl-3">&quot;arvo.orc.order.create&quot;</span><span class="hl-1">, </span><span class="hl-7">// The orchestrator name</span><br/><span class="hl-1">  </span><span class="hl-2">version:</span><span class="hl-1"> </span><span class="hl-3">&quot;1.0.0&quot;</span><span class="hl-1">, </span><span class="hl-7">// The version of the orchestrator</span><br/><span class="hl-1">  </span><span class="hl-2">initiator:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.test.test&quot;</span><span class="hl-1">, </span><span class="hl-7">// The initiator address</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">// With metadata</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">subjectWithMeta</span><span class="hl-1"> = </span><span class="hl-2">ArvoOrchestrationSubject</span><span class="hl-1">.</span><span class="hl-6">new</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">orchestator:</span><span class="hl-1"> </span><span class="hl-3">&quot;arvo.orc.order.create&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">version:</span><span class="hl-1"> </span><span class="hl-3">&quot;1.0.0&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">initiator:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.test.test&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">meta:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">environment:</span><span class="hl-1"> </span><span class="hl-3">&quot;production&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">stream_topic:</span><span class="hl-1"> </span><span class="hl-6">uuid4</span><span class="hl-1">(), </span><span class="hl-7">// [Optional] Maybe stream topic to publish all streaming events for an execution. Each execution may have a unique topic or not. Depends on the particular implementation</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<ol start="2">
<li>The method <code>ArvoOrchestrationSubject.from()</code>, enables subject chaining—a powerful feature for maintaining context across complex workflows. This method allows creating a new orchestration subject from an existing parent subject, preserving the relationship between different process stages. By parsing the parent subject and merging metadata, developers can create child subjects that inherit and extend the context of their predecessors.</li>
</ol>
<pre><code class="typescript"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">ArvoOrchestrationSubject</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;arvo-core&#39;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">v4</span><span class="hl-1"> </span><span class="hl-0">as</span><span class="hl-1"> </span><span class="hl-2">uuid4</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;uuid&#39;</span><br/><br/><span class="hl-7">// Create a parent subject</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">parentSubject</span><span class="hl-1"> = </span><span class="hl-2">ArvoOrchestrationSubject</span><span class="hl-1">.</span><span class="hl-6">new</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">orchestator:</span><span class="hl-1"> </span><span class="hl-3">&quot;parentProcess&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">version:</span><span class="hl-1"> </span><span class="hl-3">&quot;1.0.0&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">initiator:</span><span class="hl-1"> </span><span class="hl-3">&quot;systemA&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">meta:</span><span class="hl-1"> { </span><span class="hl-2">environment:</span><span class="hl-1"> </span><span class="hl-3">&quot;production&quot;</span><span class="hl-1"> }</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-7">// Create a new subject from the parent</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">childSubject</span><span class="hl-1"> = </span><span class="hl-2">ArvoOrchestrationSubject</span><span class="hl-1">.</span><span class="hl-6">from</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-2">orchestator:</span><span class="hl-1"> </span><span class="hl-3">&quot;childProcess&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">version:</span><span class="hl-1"> </span><span class="hl-3">&quot;2.0.0&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">subject:</span><span class="hl-1"> </span><span class="hl-2">parentSubject</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">meta:</span><span class="hl-1"> { </span><span class="hl-2">step:</span><span class="hl-1"> </span><span class="hl-3">&quot;processing&quot;</span><span class="hl-1"> }  </span><span class="hl-7">// Will be merged with parent&#39;s metadata</span><br/><span class="hl-1">});</span>
</code><button type="button">Copy</button></pre>

<blockquote>
<p>For those seeking a deeper understanding of the intricacies of <code>ArvoOrchestrationSubject</code>, the comprehensive <a href="https://saadahmad123.github.io/arvo-core/classes/index.ArvoOrchestrationSubject.html">technical documentation</a> offers extensive details about its implementation and usage.</p>
</blockquote>
<a id="md:anti-patterns-in-subject-usage" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Anti-patterns in Subject Usage<a href="#md:anti-patterns-in-subject-usage" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>While the <code>subject</code> field represents a powerful mechanism for contextual tracking in Arvo's event-driven architecture, its flexibility can also lead to potential misuse that undermines system design principles. Developers must exercise careful restraint to prevent the subject from becoming an unintended catch-all for system metadata.</p>
<p>The primary anti-pattern to avoid is transforming the <code>subject</code> into a bloated information container. Despite its seemingly flexible nature, the subject should remain focused on its core purpose: providing a unique, consistent identifier for tracking workflow progression. Overloading the subject with excessive metadata quickly leads to decreased system readability, increased complexity, and potential performance overhead.</p>
<p>A strict architectural guideline emerges from this consideration: metadata should be kept minimal and purposeful. If absolutely necessary, limit additional metadata to no more than three string fields. However, the preferred approach is to store complex contextual information elsewhere in the system architecture. For extensive metadata requirements, developers should leverage alternative strategies such as:</p>
<ol>
<li>Storing detailed information in a dedicated data plane and referencing it through a compact key</li>
<li>Utilizing the <code>data</code> field for comprehensive contextual information</li>
<li>Employing dedicated metadata management services that can be referenced through lightweight identifiers</li>
</ol>
<p>By maintaining a disciplined approach to subject creation, architects can preserve the clean, focused design that makes Arvo's event handling so powerful and maintainable. The subject should remain a precise, lightweight mechanism for tracking event lineage, not a dumping ground for system-wide contextual information.</p>
<a id="md:deep-dive-system-observability" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Deep Dive: System Observability<a href="#md:deep-dive-system-observability" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>System observability in distributed event-driven architectures presents unique challenges, particularly in tracing events as they flow between multiple services. Arvo addresses this challenge through native integration with OpenTelemetry, implementing distributed tracing through two critical event extensions: <code>traceparent</code> and <code>tracestate</code>. The <code>traceparent</code> field carries the core OpenTelemetry context, including trace ID, span ID, and trace flags, maintaining the connection between different spans as events traverse service boundaries. Meanwhile, the <code>tracestate</code> field supports vendor-specific tracing information, allowing organisations to include additional context while remaining compatible with the OpenTelemetry specification. This implementation ensures that when an event leaves one handler and moves to another, the tracing context seamlessly transfers, maintaining an unbroken chain of observability across the entire system.</p>
<p>In Arvo event handlers and related components leverage these trace contexts automatically, creating new spans for each event processing operation while preserving the broader trace context. When a handler receives an event, it extracts the <code>traceparent</code> and <code>tracestate</code> information to create a child span, executing its business logic within this context. Upon completion, any emitted events inherit this tracing context, ensuring that the entire event chain remains observable and debuggable.</p>
<pre><code class="typescript"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">event</span><span class="hl-1"> = </span><span class="hl-6">createArvoEvent</span><span class="hl-1">(</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-2">source:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.inventory.builder&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.stock.updated&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">subject:</span><span class="hl-1"> </span><span class="hl-3">&quot;product/456&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">data:</span><span class="hl-1"> {</span><br/><span class="hl-1">	    </span><span class="hl-2">name:</span><span class="hl-1"> </span><span class="hl-3">&quot;apple macbook&quot;</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-7">// Accessing trace information</span><br/><span class="hl-2">console</span><span class="hl-1">.</span><span class="hl-6">log</span><span class="hl-1">(</span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">traceparent</span><span class="hl-1">);</span><br/><span class="hl-7">// Accessing the open telemetry attributes</span><br/><span class="hl-2">console</span><span class="hl-1">.</span><span class="hl-6">log</span><span class="hl-1">(</span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">otelAttributes</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<a id="md:deep-dive-event-routing-architecture" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Deep Dive: Event Routing Architecture<a href="#md:deep-dive-event-routing-architecture" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Arvo implements an elegant and powerful event routing system that ensures reliable message delivery while maintaining service independence. At its core, the routing mechanism revolves around three fundamental fields: <code>to</code>, <code>source</code>, and <code>redirectto</code>. These fields work in concert to create a flexible yet predictable event routing system that supports both simple point-to-point communication and complex workflows.</p>
<blockquote>
<p><strong>Good to consider</strong>: Before diving into the technical details, it's worth noting that most developers won't need to implement this routing logic directly. Arvo provides high-level handlers, orchestrators, and utility factories that handle these mechanics automatically. For complex event chains, Arvo recommends using the <code>ArvoOrchestrator</code> from <code>arvo-xstate</code> rather than implementing service-to-service choreography manually. The <code>ArvoOrchestrator</code> leverages state machines to manage complex workflows while abstracting away the routing complexity.</p>
</blockquote>
<a id="md:the-event-broker-the-heart-of-routing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">The Event Broker: The Heart of Routing<a href="#md:the-event-broker-the-heart-of-routing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>At the centre of Arvo's architecture sits the event broker, which serves as the central nervous system for all event routing. The broker should follow a strict contract with handlers that ensures consistent and predictable event delivery. When an event arrives, the broker should performs a critical matching operation:</p>
<ol>
<li>Examine the event's <code>to</code> field to determine the intended destination</li>
<li>Compare this destination against the <code>source</code> field of all registered handlers</li>
<li>Only when it finds an exact match will it forward the event to the corresponding handler</li>
</ol>
<p>This matching process is fundamental to Arvo's routing system. It ensures that events always reach their intended destinations while maintaining loose coupling between services.</p>
<blockquote>
<p><strong>Note:</strong> All event handlers defined in Arvo have a <code>source</code> field and can be accessed via <code>handler.source</code>. This is because all event handlers and event routers provided by Arvo inherit from <code>AbstractArvoEventHandler</code>.  Every event handler object computes it based on its configuration parameters. You can read more about it in the <code>arvo-event-handler</code> documentation</p>
</blockquote>
<a id="md:core-routing-fields" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Core Routing Fields<a href="#md:core-routing-fields" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Let's examine each routing field in detail:</p>
<a id="md:the-to-field-primary-destination-address" class="tsd-anchor"></a><h4 class="tsd-anchor-link">The <code>to</code> Field: Primary Destination Address<a href="#md:the-to-field-primary-destination-address" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The <code>to</code> field serves as the primary addressing mechanism in Arvo's routing system. It uses a reverse-DNS format (e.g., <code>com.company.service</code>) to identify destination services. While the <code>to</code> field should often match an event's <code>type</code>, they can differ to support more sophisticated routing scenarios. For example:</p>
<pre><code class="typescript"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">event</span><span class="hl-1"> = { </span><br/><span class="hl-1">	</span><span class="hl-2">to:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.finance.service&quot;</span><span class="hl-1">,  </span><span class="hl-7">// Routing destination </span><br/><span class="hl-1">	</span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.orders.payment.init&quot;</span><span class="hl-1">,  </span><span class="hl-7">// Event type for handler selection </span><br/><span class="hl-1">	</span><span class="hl-7">// ... other fields </span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>In this case, while the event represents an order payment initialisation, it's routed to a central financial service that handles various payment-related operations.</p>
<blockquote>
<p><strong>Good to consider</strong>: It is always a better idea to not use this kind of routing unless absolutely necessary. This is because it adds another layer of routing not handled by the event broker and less monitoring may be available. Moreover the producer of the event will then have to explicitly specify the event <code>type</code> as well as the <code>to</code> field (in which case this will end up being not governed by the <code>ArvoContract</code>)</p>
</blockquote>
<a id="md:the-source-field-event-origin-and-default-return-path" class="tsd-anchor"></a><h4 class="tsd-anchor-link">The <code>source</code> Field: Event Origin and Default Return Path<a href="#md:the-source-field-event-origin-and-default-return-path" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The <code>source</code> field identifies where an event originated and typically serves as the return address for responses. Every handler in Arvo has a unique <code>source</code> identifier that serves two purposes:</p>
<ol>
<li>As a receiving address when matching against incoming events' <code>to</code> fields</li>
<li>As the default <code>to</code> field for any events the handler emits (taken from the event consumed by the handler - logic is explain below in the documentation)</li>
</ol>
<p>This dual role creates clear event trails and enables automatic response routing. You can access a handler's source through the <code>handler.source</code> property, as all Arvo handlers inherit from <code>AbstractArvoEventHandler</code>.</p>
<blockquote>
<p>The <code>ArvoEventHandler</code> will automatically populate the event <code>source</code> it field for all the events it emits from the <code>this&lt;handler&gt;.source</code>.</p>
</blockquote>
<a id="md:the-redirectto-field-alternative-response-routing" class="tsd-anchor"></a><h4 class="tsd-anchor-link">The <code>redirectto</code> Field: Alternative Response Routing<a href="#md:the-redirectto-field-alternative-response-routing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The <code>redirectto</code> field enables more sophisticated routing patterns by specifying an alternative destination for responses. This is particularly valuable in multi-step workflows where responses should flow to a different service than the original sender. Consider this order processing example:</p>
<pre><code class="typescript"><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">paymentEvent</span><span class="hl-1"> = {</span><br/><span class="hl-1">    </span><span class="hl-2">to:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.payment.service&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">redirectto:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.shipping.service&quot;</span><span class="hl-1">,  </span><span class="hl-7">// Next step in the workflow</span><br/><span class="hl-1">    </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&quot;com.orders.payment.process&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">data:</span><span class="hl-1"> { </span><span class="hl-2">orderId:</span><span class="hl-1"> </span><span class="hl-3">&quot;123&quot;</span><span class="hl-1">, </span><span class="hl-2">amount:</span><span class="hl-1"> </span><span class="hl-9">99.99</span><span class="hl-1"> }</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>When the payment service processes this event, its response will automatically route to the shipping service rather than returning to the original sender.</p>
<a id="md:routing-logic-in-action" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Routing Logic in Action<a href="#md:routing-logic-in-action" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The event handlers in Arvo are responsible to executing the logic for setting the field appropriately in the event, this way the event broker does not have to implement and complex logic and the event handler get more flexibility.</p>
<p>For newly created events:</p>
<pre><code class="typescript"><span class="hl-7">// When creating an initial event, the destination is determined by:</span><br/><span class="hl-7">// 1. Explicitly provided &#39;to&#39; address if available</span><br/><span class="hl-7">// 2. Otherwise, defaults to the event type</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">destination</span><span class="hl-1"> = </span><span class="hl-2">initParams</span><span class="hl-1">.</span><span class="hl-2">to</span><span class="hl-1"> ?? </span><span class="hl-2">initParams</span><span class="hl-1">.</span><span class="hl-2">type</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<p>For response events, the routing follows a priority-based decision tree:</p>
<pre><code class="typescript"><span class="hl-7">// Response routing priority:</span><br/><span class="hl-7">// 1. Handler-specified destination</span><br/><span class="hl-7">// 2. Original event&#39;s redirect address</span><br/><span class="hl-7">// 3. Original event&#39;s source</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">responseDestination</span><span class="hl-1"> = </span><br/><span class="hl-1">    </span><span class="hl-2">handlerResponse</span><span class="hl-1">.</span><span class="hl-2">to</span><span class="hl-1"> ?? </span><br/><span class="hl-1">    </span><span class="hl-2">sourceEvent</span><span class="hl-1">.</span><span class="hl-2">redirectto</span><span class="hl-1"> ?? </span><br/><span class="hl-1">    </span><span class="hl-2">sourceEvent</span><span class="hl-1">.</span><span class="hl-2">source</span><span class="hl-1">;</span><br/><br/><span class="hl-7">// Redirect handling preserves explicit redirects</span><br/><span class="hl-7">// but clears them if not specified by handler</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">responseRedirect</span><span class="hl-1"> = </span><span class="hl-2">handlerResponse</span><span class="hl-1">.</span><span class="hl-2">redirectto</span><span class="hl-1"> ?? </span><span class="hl-4">null</span><span class="hl-1">;</span>
</code><button type="button">Copy</button></pre>

<a id="md:implementing-event-routing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Implementing Event Routing<a href="#md:implementing-event-routing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>While Arvo's handlers implement this routing logic automatically, understanding how to work with it is valuable. Here's an example of creating a payment processing handler that implements explicit routing:</p>
<pre><code class="typescript"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-0">type</span><span class="hl-1"> </span><span class="hl-2">EventHandlerFactory</span><span class="hl-1">, </span><span class="hl-2">createArvoEventHandler</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&#39;arvo-event-handler&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-6">processPaymentHandlerFactory</span><span class="hl-1">: </span><span class="hl-8">EventHandlerFactory</span><span class="hl-1"> = () </span><span class="hl-4">=&gt;</span><span class="hl-1"> </span><br/><span class="hl-1">    </span><span class="hl-6">createArvoEventHandler</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-2">contract:</span><span class="hl-1"> </span><span class="hl-2">paymentContract</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">executionunits:</span><span class="hl-1"> </span><span class="hl-9">1e-6</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-2">handler:</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-3">&#39;1.0.0&#39;</span><span class="hl-2">:</span><span class="hl-1"> </span><span class="hl-4">async</span><span class="hl-1"> ({</span><span class="hl-2">event</span><span class="hl-1">}) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-7">// Process payment logic here</span><br/><span class="hl-1">                </span><span class="hl-0">return</span><span class="hl-1"> {</span><br/><span class="hl-1">                    </span><span class="hl-2">type:</span><span class="hl-1"> </span><span class="hl-3">&#39;evt.payment.processed&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">                    </span><span class="hl-2">to:</span><span class="hl-1"> </span><span class="hl-3">&#39;com.shipping.service&#39;</span><span class="hl-1">,     </span><span class="hl-7">// Explicit next destination</span><br/><span class="hl-1">                    </span><span class="hl-2">redirectto:</span><span class="hl-1"> </span><span class="hl-3">&#39;com.notification.service&#39;</span><span class="hl-1">, </span><span class="hl-7">// Future response destination</span><br/><span class="hl-1">                    </span><span class="hl-2">data:</span><span class="hl-1"> { </span><br/><span class="hl-1">                        </span><span class="hl-2">orderId:</span><span class="hl-1"> </span><span class="hl-2">event</span><span class="hl-1">.</span><span class="hl-2">data</span><span class="hl-1">.</span><span class="hl-2">orderId</span><span class="hl-1">,</span><br/><span class="hl-1">                        </span><span class="hl-2">status:</span><span class="hl-1"> </span><span class="hl-3">&#39;paid&#39;</span><span class="hl-1"> </span><br/><span class="hl-1">                    }</span><br/><span class="hl-1">                };</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span>
</code><button type="button">Copy</button></pre>

<a id="md:best-practices-for-event-routing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Best Practices for Event Routing<a href="#md:best-practices-for-event-routing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The most important principle is knowing when and how to use Arvo's specialized components for complex workflows.</p>
<a id="md:always-use-the-arvoorchestrator" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Always use the <code>ArvoOrchestrator</code><a href="#md:always-use-the-arvoorchestrator" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The <code>ArvoOrchestrator</code> stands as Arvo's primary solution for managing complex event flows, but it's crucial to understand that it differs significantly from traditional orchestrators. Unlike conventional orchestrators that actively direct traffic and maintain complex state machines, the ArvoOrchestrator functions as just another event handler within your system - one with a specific focus on coordination. It maintains its own bounded context and follows the same event-handling patterns as any other service, but its specialised purpose is implementing state machines that coordinate complex workflows.</p>
<p>When you use <code>ArvoOrchestrator</code>, you're not creating a central point of control that could become a bottleneck. Instead, you're defining a state machine (via <code>xstate</code>) that responds to events and emits new events based on its current state. This approach maintains the distributed nature of your system while providing the coordination benefits typically associated with orchestration. The orchestrator becomes just another participant in your event-driven architecture, albeit one focused on managing process flow.</p>
<blockquote>
<p>For more information, see <code>arvo-xstate</code> package in NPM</p>
</blockquote>
<a id="md:maintain-clear-service-boundaries" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Maintain clear service boundaries<a href="#md:maintain-clear-service-boundaries" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Service boundaries play a crucial role in effective event routing. Each service should have clearly defined responsibilities and operate within its bounded context. This clarity makes routing decisions more straightforward and helps prevent the creation of tangled dependencies between services. When designing your services, think carefully about their boundaries and ensure they align with your business domains.</p>
<a id="md:conclusion" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Conclusion<a href="#md:conclusion" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>ArvoEvent represents a sophisticated approach to solving key challenges in event-driven architectures. By extending the CloudEvents specification and introducing targeted enterprise-grade extensions, it provides a robust framework for:</p>
<ul>
<li><strong>Standardisation</strong>: Creating consistent event semantics across distributed systems</li>
<li><strong>Flexibility</strong>: Supporting diverse business needs while maintaining architectural integrity</li>
<li><strong>Observability</strong>: Enabling comprehensive tracing and monitoring</li>
<li><strong>Routing</strong>: Implementing intelligent event delivery mechanisms</li>
</ul>
<p>The design prioritises service independence, evolutionary architecture, and scalable communication. Developers gain a powerful tool for building complex, responsive, and maintainable event-driven systems that can adapt to changing business requirements.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:arvoevent---a-event-design-for-evolutionary-and-reliable-event-driven-architecture"><span>Arvo<wbr/>Event -<wbr/> <wbr/>A <wbr/>Event <wbr/>Design for <wbr/>Evolutionary and <wbr/>Reliable <wbr/>Event-<wbr/>Driven <wbr/>Architecture</span></a><ul><li><a href="#md:the-challenge-of-event-standardisation"><span>The <wbr/>Challenge of <wbr/>Event <wbr/>Standardisation</span></a></li><li><a href="#md:core-architecture-the-event-broker-pattern"><span>Core <wbr/>Architecture: <wbr/>The <wbr/>Event <wbr/>Broker <wbr/>Pattern</span></a></li><li><a href="#md:the-arvoevent-structure"><span>The <wbr/>Arvo<wbr/>Event structure</span></a></li><li><a href="#md:creating-arvoevents"><span>Creating <wbr/>Arvo<wbr/>Events</span></a></li><li><a href="#md:data-serialisation-and-immutability"><span>Data <wbr/>Serialisation and <wbr/>Immutability</span></a></li><li><a href="#md:working-with-event-metadata"><span>Working with <wbr/>Event <wbr/>Metadata</span></a></li><li><a href="#md:the-subject-field-in-arvos-event-driven-orchestration-model"><span>The subject <wbr/>Field in <wbr/>Arvo&#39;s <wbr/>Event-<wbr/>Driven <wbr/>Orchestration <wbr/>Model</span></a></li><li><ul><li><a href="#md:creating-a-subject-in-arvo"><span>Creating a subject in <wbr/>Arvo</span></a></li><li><ul><li><a href="#md:anti-patterns-in-subject-usage"><span>Anti-<wbr/>patterns in <wbr/>Subject <wbr/>Usage</span></a></li></ul></li></ul></li><li><a href="#md:deep-dive-system-observability"><span>Deep <wbr/>Dive: <wbr/>System <wbr/>Observability</span></a></li><li><a href="#md:deep-dive-event-routing-architecture"><span>Deep <wbr/>Dive: <wbr/>Event <wbr/>Routing <wbr/>Architecture</span></a></li><li><ul><li><a href="#md:the-event-broker-the-heart-of-routing"><span>The <wbr/>Event <wbr/>Broker: <wbr/>The <wbr/>Heart of <wbr/>Routing</span></a></li><li><a href="#md:core-routing-fields"><span>Core <wbr/>Routing <wbr/>Fields</span></a></li><li><ul><li><a href="#md:the-to-field-primary-destination-address"><span>The to <wbr/>Field: <wbr/>Primary <wbr/>Destination <wbr/>Address</span></a></li><li><a href="#md:the-source-field-event-origin-and-default-return-path"><span>The source <wbr/>Field: <wbr/>Event <wbr/>Origin and <wbr/>Default <wbr/>Return <wbr/>Path</span></a></li><li><a href="#md:the-redirectto-field-alternative-response-routing"><span>The redirectto <wbr/>Field: <wbr/>Alternative <wbr/>Response <wbr/>Routing</span></a></li></ul></li><li><a href="#md:routing-logic-in-action"><span>Routing <wbr/>Logic in <wbr/>Action</span></a></li><li><a href="#md:implementing-event-routing"><span>Implementing <wbr/>Event <wbr/>Routing</span></a></li><li><a href="#md:best-practices-for-event-routing"><span>Best <wbr/>Practices for <wbr/>Event <wbr/>Routing</span></a></li><li><ul><li><a href="#md:always-use-the-arvoorchestrator"><span>Always use the <wbr/>Arvo<wbr/>Orchestrator</span></a></li><li><a href="#md:maintain-clear-service-boundaries"><span>Maintain clear service boundaries</span></a></li></ul></li></ul></li><li><a href="#md:conclusion"><span>Conclusion</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="../index.html"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-1"></use></svg><span>arvo-core</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base=".."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a> with <a href="https://github.com/KillerJulian/typedoc-github-theme" target="_blank">typedoc-github-theme</a></p></footer><div class="overlay"></div></body></html>
